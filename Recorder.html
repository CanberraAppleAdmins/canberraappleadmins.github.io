<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .record-btn {
            background-color: #dc3545;
        }
        
        .record-btn:hover {
            background-color: #c82333;
        }
        
        .record-btn.recording {
            background-color: #28a745;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .timer {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #dc3545;
            margin: 10px 0;
        }
        
        audio {
            width: 100%;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Audio Recorder</h1>
        
        <div class="form-group">
            <label for="userName">Your Name:</label>
            <input type="text" id="userName" placeholder="Enter your name" required>
        </div>
        
        <div class="controls">
            <button id="recordBtn" class="record-btn">Start Recording</button>
            <button id="stopBtn" disabled>Stop Recording</button>
            <button id="playBtn" disabled>Play Recording</button>
            <button id="saveBtn" disabled>Save as MP3</button>
        </div>
        
        <div id="timer" class="timer" style="display: none;">00:00</div>
        
        <audio id="audioPlayback" controls style="display: none;"></audio>
        
        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime;
        let timerInterval;
        let audioBlob = null;

        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const playBtn = document.getElementById('playBtn');
        const saveBtn = document.getElementById('saveBtn');
        const userNameInput = document.getElementById('userName');
        const audioPlayback = document.getElementById('audioPlayback');
        const status = document.getElementById('status');
        const timer = document.getElementById('timer');

        // Check for browser support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showStatus('Your browser does not support audio recording.', 'error');
        }

        recordBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
        playBtn.addEventListener('click', playRecording);
        saveBtn.addEventListener('click', saveRecording);

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Reset previous recording
                audioChunks = [];
                audioBlob = null;
                audioPlayback.style.display = 'none';
                
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;
                    audioPlayback.style.display = 'block';
                    
                    // Enable play and save buttons
                    playBtn.disabled = false;
                    saveBtn.disabled = false;
                    
                    showStatus('Recording completed successfully!', 'success');
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                // Update UI
                recordBtn.disabled = true;
                recordBtn.classList.add('recording');
                stopBtn.disabled = false;
                playBtn.disabled = true;
                saveBtn.disabled = true;
                
                // Start timer
                timer.style.display = 'block';
                timerInterval = setInterval(updateTimer, 1000);
                
                showStatus('Recording in progress...', 'info');
                
            } catch (error) {
                showStatus('Error accessing microphone: ' + error.message, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                // Update UI
                recordBtn.disabled = false;
                recordBtn.classList.remove('recording');
                stopBtn.disabled = true;
                
                // Stop timer
                clearInterval(timerInterval);
                timer.style.display = 'none';
            }
        }

        function playRecording() {
            if (audioBlob) {
                audioPlayback.play();
            }
        }

        async function saveRecording() {
            const userName = userNameInput.value.trim();
            
            if (!userName) {
                showStatus('Please enter your name before saving.', 'error');
                userNameInput.focus();
                return;
            }
            
            if (!audioBlob) {
                showStatus('No recording to save.', 'error');
                return;
            }
            
            // TODO: Replace with your actual SAS token
            const sasToken = 'sp=r&st=2025-07-31T03:40:11Z&se=2025-08-07T11:55:11Z&spr=https&sv=2024-11-04&sr=c&sig=7AtRJMerfWjWIp7cWB6m9ehIOoG4QMGcalw6Eo4P%2B9E%3D';
            
            if (sasToken === 'YOUR_SAS_TOKEN_HERE') {
                showStatus('Please configure the SAS token first.', 'error');
                return;
            }
            
            try {
                const fileName = sanitiseFileName(userName) + '_' + getCurrentTimestamp() + '.wav';
                const blobUrl = 'https://radpowerapp.blob.core.windows.net/nexuspronounce/' + fileName + '?' + sasToken;
                
                showStatus('Saving recording to Azure Blob Storage...', 'info');
                
                const response = await fetch(blobUrl, {
                    method: 'PUT',
                    headers: {
                        'x-ms-blob-type': 'BlockBlob',
                        'x-ms-blob-content-type': 'audio/wav'
                    },
                    body: audioBlob
                });
                
                if (response.ok) {
                    showStatus('Recording saved successfully as: ' + fileName, 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error('Azure Storage error (' + response.status + '): ' + errorText);
                }
                
            } catch (error) {
                showStatus('Error saving recording: ' + error.message, 'error');
            }
        }

        function updateTimer() {
            if (isRecording) {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                timer.textContent = minutes + ':' + seconds;
            }
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            
            // Hide status after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        function sanitiseFileName(name) {
            // Remove special characters and replace spaces with underscores
            return name.replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_').toLowerCase();
        }

        function getCurrentTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            return year + month + day + '_' + hours + minutes + seconds;
        }
    </script>
</body>
</html>